{
    "variables": {
      "ami_version": "1.0.0",
      "ami_user": "
      "ami_base_name": "ami-rnaseq",
      "ec2_user": "ubuntu",
      "instance_type": "c5a.large",
      "root_volume_size_Gi": "30"
    },
    "builders": [
      {
        "type": "amazon-ebs",
        "ami_name": "{{user `ami_base_name`}}-{{timestamp}}",
        "ami_description": "AMI supportsRNA-Seq analysis pipeline (base)",
        "region": "us-west-2",
        "instance_type": "{{user `instance_type`}}",
        "ami_users": [
          "{{user `ami_user`}}"
        ],
        "ssh_username": "{{user `ec2_user`}}",
        "ena_support": true,
        "launch_block_device_mappings": [
          {
            "device_name": "/dev/sda1",
            "volume_size": "{{user `root_volume_size_Gi`}}",
            "volume_type": "gp2",
            "delete_on_termination": true
          }
        ],
        "source_ami_filter": {
            "filters": {
            "virtualization-type": "hvm",
            "name": "ubuntu/images/hvm-ssd/ubuntu-*18.04*-amd64-server-*",
            "root-device-type": "ebs"
            },
            "owners": ["099720109477"],
            "most_recent": true
        },
        "tags": {
          "OS_Version": "Ubuntu",
          "Release": "18.04",
          "Base_AMI_Name": "{{ .SourceAMIName }}",
          "Extra": "{{ .SourceAMITags.TagName }}"
        },
        "run_tags": { "Name": "ami-build" }
      }
    ],
   "provisioners": [
    {
      "type": "file",
      "source": "profile.d/conda.sh",
      "destination": "/tmp/conda.sh"
    },
    {
      "type": "shell",
      "inline": [
        "sudo cp /tmp/conda.sh /etc/profile.d/conda.sh"
      ]
    },
    {
      "type": "shell",
      "script": "./build_script.sh",
      "execute_command": "/usr/bin/cloud-init status --wait && sudo -E -S sh '{{ .Path }}'"
    }
    ]
  }
  